# ═══════════════════════════════════════════════════════════
# ENOVA CI/CD Pipeline
# GitHub Actions workflow with Blue-Green deployment
# ═══════════════════════════════════════════════════════════

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  K8S_NAMESPACE: enova

jobs:
  # ─────────────────────────────────────────────────────────
  # Stage 1: Lint & Test
  # ─────────────────────────────────────────────────────────
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies (Backend)
        working-directory: enova-backend
        run: npm ci

      - name: Lint Backend
        working-directory: enova-backend
        run: npm run lint

      - name: Test Backend
        working-directory: enova-backend
        run: npm run test

      - name: Install dependencies (Frontend)
        working-directory: .
        run: npm ci

      - name: Lint Frontend
        working-directory: .
        run: npm run lint

      - name: Test Frontend
        working-directory: .
        run: npm run test -- --passWithNoTests

  # ─────────────────────────────────────────────────────────
  # Stage 2: Build Docker Images
  # ─────────────────────────────────────────────────────────
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - name: api-gateway
            context: enova-backend
            dockerfile: enova-backend/docker/backend.Dockerfile
          - name: auth-service
            context: enova-backend
            dockerfile: enova-backend/docker/backend.Dockerfile
          - name: community-service
            context: enova-backend
            dockerfile: enova-backend/docker/backend.Dockerfile
          - name: chat-service
            context: enova-backend
            dockerfile: enova-backend/docker/backend.Dockerfile
          - name: frontend
            context: .
            dockerfile: docker/frontend.Dockerfile

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service.name }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            SERVICE_NAME=${{ matrix.service.name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    # Disable deployment temporarily until cluster is ready
    if: false # github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://enova.app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            echo "::error::KUBECONFIG secret is not set in GitHub Secrets!"
            exit 1
          fi
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify Cluster Connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Get image tag
        id: tag
        run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # ─────────────────────────────────────────────────────
      # Blue-Green Deployment Strategy
      # ─────────────────────────────────────────────────────
      - name: Determine deployment color
        id: color
        run: |
          CURRENT=$(kubectl get svc api-gateway -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.spec.selector.version}' 2>/dev/null || echo "blue")
          if [ "$CURRENT" = "blue" ]; then
            echo "NEW_COLOR=green" >> $GITHUB_OUTPUT
            echo "OLD_COLOR=blue" >> $GITHUB_OUTPUT
          else
            echo "NEW_COLOR=blue" >> $GITHUB_OUTPUT
            echo "OLD_COLOR=green" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to new color (Green)
        run: |
          # Update image tags in manifests
          find k8s/services -name "*.yaml" -exec sed -i \
            -e "s|\${REGISTRY}|${{ env.REGISTRY }}/${{ github.repository }}|g" \
            -e "s|\${IMAGE_TAG}|${{ steps.tag.outputs.TAG }}|g" {} \;

          # Add version label for blue-green
          find k8s/services -name "*.yaml" -exec sed -i \
            -e "s|app: \(.*\)|app: \1\n        version: ${{ steps.color.outputs.NEW_COLOR }}|g" {} \;

          # Apply new deployment
          kubectl apply -f k8s/base/
          kubectl apply -f k8s/services/ -R

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/api-gateway -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/auth-service -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/community-service -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/chat-service -n ${{ env.K8S_NAMESPACE }} --timeout=300s

      - name: Run smoke tests
        id: smoke
        run: |
          # Wait for pods to be ready
          sleep 30

          # Test health endpoints
          GATEWAY_POD=$(kubectl get pod -n ${{ env.K8S_NAMESPACE }} -l app=api-gateway -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $GATEWAY_POD -- wget -q -O- http://localhost:3000/health

          echo "Smoke tests passed"

      - name: Switch traffic to new color
        if: steps.smoke.outcome == 'success'
        run: |
          # Update service selector to point to new deployment
          kubectl patch svc api-gateway -n ${{ env.K8S_NAMESPACE }} \
            -p '{"spec":{"selector":{"version":"${{ steps.color.outputs.NEW_COLOR }}"}}}'

          kubectl patch svc auth-service -n ${{ env.K8S_NAMESPACE }} \
            -p '{"spec":{"selector":{"version":"${{ steps.color.outputs.NEW_COLOR }}"}}}'

          kubectl patch svc community-service -n ${{ env.K8S_NAMESPACE }} \
            -p '{"spec":{"selector":{"version":"${{ steps.color.outputs.NEW_COLOR }}"}}}'

          kubectl patch svc chat-service -n ${{ env.K8S_NAMESPACE }} \
            -p '{"spec":{"selector":{"version":"${{ steps.color.outputs.NEW_COLOR }}"}}}'

      - name: Scale down old deployment
        if: steps.smoke.outcome == 'success'
        run: |
          # Keep old deployment at 1 replica for quick rollback
          kubectl scale deployment -n ${{ env.K8S_NAMESPACE }} \
            -l version=${{ steps.color.outputs.OLD_COLOR }} --replicas=1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          kubectl rollout undo deployment/api-gateway -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/auth-service -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/community-service -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/chat-service -n ${{ env.K8S_NAMESPACE }}

      - name: Notify deployment success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Image tag: ${{ steps.tag.outputs.TAG }}"
          echo "Color: ${{ steps.color.outputs.NEW_COLOR }}"
